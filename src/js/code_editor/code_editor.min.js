(function(){window.textEditor=function(id){if(!document.getElementById(id))throw new Error("Invalid ID parameter: "+id);this.id=id;this.textarea=document.getElementById(id);this.shortcuts=[];this._key_map={8:'backspace',9:'tab',13:'enter',16:'shift',17:'ctrl',18:'alt',20:'capslock',27:'esc',32:'space',33:'pageup',34:'pagedown',35:'end',36:'home',37:'left',38:'up',39:'right',40:'down',45:'ins',46:'del',91:'meta',93:'meta',224:'meta',106:false,107:false,109:false,110:false,111:false,186:false,187:false,188:false,189:false,190:false,191:false,192:false,219:false,220:false,221:false,222:false};for(var i=1;i<20;++i)this._key_map[111+i]='f'+i;for(i=0;i<=9;++i)this._key_map[i+96]=i;this.preventKeyPress=false;var that=this;this.textarea.addEventListener('keydown',this.keyEvent,true);this.textarea.addEventListener('keypress',this.keyEvent,true);};textEditor.prototype.keyEvent=function(e){var e=e||window.event;if(that.preventKeyPress&&e.type=='keypress'){that.preventKeyPress=false;return that.preventDefault(e);}for(var key in that.shortcuts){var shortcut=that.shortcuts[key];if(e.metaKey)continue;if((e.ctrlKey&&!shortcut.ctrl)||(shortcut.ctrl&&!e.ctrlKey))continue;if((e.shiftKey&&!shortcut.shift)||(shortcut.shift&&!e.shiftKey))continue;if((e.altKey&&!shortcut.alt)||(shortcut.alt&&!e.altKey))continue;if(!(key=that.matchKeyPress(shortcut.key,e)))continue;if(typeof shortcut.callback!='function'){var key_name=(shortcut.ctrl?'Ctrl-':'')+(shortcut.alt?'Alt-':'');key_name+=(shortcut.shift?'Shift-':'')+shortcut;throw new Error("Invalid callback type for shortcut "+key_name);}var r=shortcut.callback.call(that,e,key);if(e.type=='keydown'&&r)that.preventKeyPress=true;return r?that.preventDefault(e):true;}return true;};textEditor.prototype.matchKeyPress=function(key,e){e.key=(typeof e.which==='number'&&e.charCode)?e.which:e.keyCode;key=key.toLowerCase();if(e.type=='keypress'&&e.which)return(key==String.fromCharCode(e.key).toUpperCase())?key:false;else if(this._key_map[e.key])return(this._key_map[e.key]==key)?key:false;else return(String.fromCharCode(e.key).toLowerCase()==key)?key:false;};textEditor.prototype.preventDefault=function(e){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.returnValue=false;e.cancelBubble=true;return false;};textEditor.prototype.getSelection=function(){var e=this.textarea;if('selectionStart' in e){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)};}else if(document.selection){e.focus();var r=document.selection.createRange();var tr=e.createTextRange();var tr2=tr.duplicate();tr2.moveToBookmark(r.getBookmark());tr.setEndPoint('EndToStart',tr2);if(r==null||tr==null)return{start:e.value.length,end:e.value.length,length:0,text:''};var text_part=r.text.replace(/[\r\n]/g,'.');var text_whole=e.value.replace(/[\r\n]/g,'.');var the_start=text_whole.indexOf(text_part,tr.text.length);return{start:the_start,end:the_start+text_part.length,length:text_part.length,text:r.text};}else return{start:e.value.length,end:e.value.length,length:0,text:''};};textEditor.prototype.replaceSelection=function(selection,replace_str){var e=this.textarea;var start_pos=selection.start;var end_pos=start_pos+replace_str.length;e.value=e.value.substr(0,start_pos)+replace_str+e.value.substr(selection.end,e.value.length);this.setSelection(start_pos,end_pos);return{start:start_pos,end:end_pos,length:replace_str.length,text:replace_str};};textEditor.prototype.insertAtPosition=function(start_pos,str,new_pos){var end_pos=start_pos+str.length;var e=this.textarea;e.value=e.value.substr(0,start_pos)+str+e.value.substr(start_pos,e.value.length-start_pos);if(!new_pos)new_pos=end_pos;return this.setSelection(new_pos,new_pos);};textEditor.prototype.setSelection=function(start_pos,end_pos){var e=this.textarea;if('selectionStart' in e){e.focus();e.selectionStart=start_pos;e.selectionEnd=end_pos;}else if(document.selection){e.focus();var tr=e.createTextRange();var stop_it=start_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)start_pos=start_pos-.5;stop_it=end_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)end_pos=end_pos-.5;tr.moveEnd('textedit',-1);tr.moveStart('character',start_pos);tr.moveEnd('character',end_pos-start_pos);tr.select();}return this.getSelection();};textEditor.prototype.scrollToSelection=function(selection){var e=this.textarea;var removed=e.value.substr(selection.end);e.value=e.value.substr(0,selection.end);e.scrollTop=100000;var scroll=e.scrollTop;e.value+=removed;e.scrollTop=scroll;this.setSelection(selection.start,selection.end);};textEditor.prototype.wrapSelection=function(selection,left_str,right_str){var e=this.textarea;var scroll=e.scrollTop;var the_sel_text=selection.text;var selection=this.replaceSelection(selection,left_str+the_sel_text+right_str);if(the_sel_text=='')selection=this.setSelection(selection.start+left_str.length,selection.start+left_str.length);e.scrollTop=scroll;return selection;};}());(function(){function inherit(proto){function F(){}F.prototype=proto;return new F();}String.prototype.repeat=function(num){return new Array(num+1).join(this);};window.codeEditor=function(id){textEditor.call(this,id);this.onlinechange=null;this.onlinenumberchange=null;this.nb_lines=0;this.current_line=0;this.search_str=null;this.search_pos=0;this.params={indent_size:4,tab_size:8,convert_tabs:true,lang:{search:"Text to search?\n(regexps allowed, begin them with '/')",replace:"Text for replacement?\n(use $1, $2... for regexp replacement)",search_selection:"Text to replace in selection?\n(regexps allowed, begin them with '/')",replace_result:"%d occurence found and replaced.",goto:"Line to go to:",no_search_result:"No search result found."}};that=this;this.init();this.textarea.spellcheck=false;this.shortcuts.push({shift:true,key:'tab',callback:this.indent});this.shortcuts.push({key:'tab',callback:this.indent});this.shortcuts.push({ctrl:true,key:'f',callback:this.search});this.shortcuts.push({ctrl:true,key:'h',callback:this.searchAndReplace});this.shortcuts.push({ctrl:true,key:'g',callback:this.goToLine});this.shortcuts.push({key:'F3',callback:this.searchNext});this.shortcuts.push({key:'backspace',callback:this.backspace});this.shortcuts.push({key:'enter',callback:this.enter});this.shortcuts.push({key:'"',callback:this.insertBrackets});this.shortcuts.push({key:'\'',callback:this.insertBrackets});this.shortcuts.push({key:'[',callback:this.insertBrackets});this.shortcuts.push({key:'{',callback:this.insertBrackets});this.shortcuts.push({key:'(',callback:this.insertBrackets});this.textarea.addEventListener('keypress',this.keyEvent,true);this.textarea.addEventListener('keydown',this.keyEvent,true);};codeEditor.prototype=inherit(textEditor.prototype);codeEditor.prototype.init=function(){var that=this;this.nb_lines=this.countLines();this.parent=document.createElement('div');this.parent.className='codeEditor';this.lineCounter=document.createElement('span');this.lineCounter.className='lineCount';for(i=1;i<=this.nb_lines;i++)this.lineCounter.innerHTML+='<b>'+i+'</b>';this.lineCounter.innerHTML+='<i>---</i>';this.parent.appendChild(this.lineCounter);var container=document.createElement('div');container.className='container';container.appendChild(this.textarea.cloneNode(true));this.parent.appendChild(container);var pnode=this.textarea.parentNode;pnode.appendChild(this.parent);pnode.removeChild(this.textarea);this.textarea=this.parent.getElementsByTagName('textarea')[0];this.textarea.wrap='off';if(this.params.convert_tabs){this.textarea.value=this.textarea.value.replace(/[ ]{1,7}\t/g,' '.repeat(this.params.tab_size));this.textarea.value=this.textarea.value.replace(/\t/g,' '.repeat(this.params.tab_size));}this.textarea.addEventListener('focus',function(){that.update();},false);this.textarea.addEventListener('keyup',function(){that.update();},false);this.textarea.addEventListener('click',function(){that.update();},false);this.textarea.addEventListener('scroll',function(){that.lineCounter.scrollTop=that.textarea.scrollTop;},false);};codeEditor.prototype.update=function(){var selection=this.getSelection();var line=this.getLineNumberFromPosition(selection)+1;var nb_lines=this.countLines();this.search_pos=selection.end;if(nb_lines!=this.nb_lines){var lines=this.lineCounter.getElementsByTagName('b');for(var i=this.nb_lines;i>nb_lines;i--)this.lineCounter.removeChild(lines[i-1]);var delim=this.lineCounter.lastChild;for(var i=lines.length;i<nb_lines;i++){var b=document.createElement('b');b.innerHTML=i+1;this.lineCounter.insertBefore(b,delim);}this.nb_lines=nb_lines;if(typeof this.onlinenumberchange==='function')this.onlinenumberchange.call(this);}if(line!=this.current_line){var lines=this.lineCounter.getElementsByTagName('b');for(var i=0;i<this.nb_lines;i++)lines[i].className='';lines[line-1].className='current';this.current_line=line;if(typeof this.onlinechange==='function')this.onlinechange.call(this);}};codeEditor.prototype.countLines=function(){var match=this.textarea.value.match(/(\r?\n)/g);return match?match.length+1:1;};codeEditor.prototype.getLineNumberFromPosition=function(s){var s=s||this.getSelection();if(s.start==0)return 0;var match=this.textarea.value.substr(0,s.start).match(/(\r?\n)/g);return match?match.length:0;};codeEditor.prototype.getLines=function(){return this.textarea.value.split("\n");};codeEditor.prototype.getLine=function(line){return this.textarea.value.split("\n",line+1)[line];};codeEditor.prototype.getLinePosition=function(lines,line){var start=0;for(i=0;i<lines.length;i++){if(i==line)return{start:start+i,end:start+lines[i].length,length:lines[i].length,text:lines[i]};start+=lines[i].length;}return false;};codeEditor.prototype.goToLine=function(e){var line=window.prompt(that.params.lang.goto);if(!line)return;var l=this.textarea.value.split("\n",parseInt(line,10)).join("\n").length;this.scrollToSelection(this.setSelection(l,l));return true;};codeEditor.prototype.indent=function(e,key){var s=this.getSelection();var unindent=e.shiftKey;var lines=this.getLines();var line=this.getLineNumberFromPosition(s);var line_sel=this.getLinePosition(lines,line);var multiline_sel=(s.end>line_sel.end)?true:false;if((s.length==0||!multiline_sel)&&s.start!=line_sel.start){this.insertAtPosition(s.start,' '.repeat(this.params.indent_size));return true;}if(s.length==0&&s.start==line_sel.start){var prev_match=(line-1 in lines)?lines[line-1].match(/^(\s+)/):false;if(!prev_match||line_sel.length!=0)var insert=' '.repeat(this.params.indent_size);else var insert=' '.repeat(prev_match[1].length);this.insertAtPosition(s.start,insert);return true;}var txt=this.textarea.value.substr(s.start,(s.end-s.start));var lines=txt.split("\n");if(unindent){var r=new RegExp('^[ ]{1,'+this.params.indent_size+'}');for(var i=0;i<lines.length;i++)lines[i]=lines[i].replace(r,'');}else for(var i=0;i<lines.length;i++)lines[i]=' '.repeat(this.params.indent_size)+lines[i];txt=lines.join("\n");this.replaceSelection(s,txt);return true;};codeEditor.prototype.search=function(){if(!(this.search_str=window.prompt(this.params.lang.search,this.search_str)))return;this.search_pos=0;return this.searchNext();};codeEditor.prototype.searchNext=function(){if(!this.search_str)return true;var s=this.getSelection();var pos=s.end>=this.search_pos?this.search_pos:s.start;var txt=this.textarea.value.substr(pos);var r=this.getSearchRegexp(this.search_str);var found=txt.search(r);if(found==-1)return window.alert(this.params.lang.no_search_result);var match=txt.match(r);s.start=pos+found;s.end=s.start+match[0].length;s.length=match[0].length;s.text=match[0];this.setSelection(s.start,s.end);this.search_pos=s.end;this.scrollToSelection(s);return true;};codeEditor.prototype.getSearchRegexp=function(str,global){var r,m;if(str.substr(0,1)=='/'){var pos=str.lastIndexOf("/");r=str.substr(1,pos-1);m=str.substr(pos+1).replace(/g/,'');}else{r=str.replace(/([\/$^.?()[\]{}\\])/,'\\$1');m='i';}if(global)m+='g';return new RegExp(r,m);};codeEditor.prototype.searchAndReplace=function(e){var selection=this.getSelection();var search_prompt=selection.length!=0?this.params.lang.search_selection:this.params.lang.search;if(!(s=window.prompt(search_prompt,this.search_str))||!(r=window.prompt(that.params.lang.replace)))return true;var regexp=this.getSearchRegexp(s,true);if(selection.length==0){var nb=this.textarea.value.match(regexp).length;this.textarea.value=this.textarea.value.replace(regexp,r);}else{var nb=selection.text.match(regexp).length;this.replaceSelection(selection,selection.text.replace(regexp,r));}window.alert(this.params.lang.replace_result.replace(/%d/g,nb));return true;};codeEditor.prototype.enter=function(e){var selection=this.getSelection();var line=this.getLineNumberFromPosition(selection);var indent='';line=this.getLine(line);if(this.textarea.value.substr(selection.start-1,1)=='{')indent+=' '.repeat(this.params.indent_size);if(match=line.match(/^(\s+)/))indent+=match[1];if(!indent)return false;this.insertAtPosition(selection.start,"\n"+indent);return true;};codeEditor.prototype.backspace=function(e){var s=this.getSelection();if(s.length>0)return false;var txt=this.textarea.value.substr(s.start-2,2);if(txt=='""'||txt=="''"||txt=='{}'||txt=='()'||txt=='[]'){s.start-=2;this.replaceSelection(s,'');return true;}var txt=this.textarea.value.substr(s.start-20,20);if((pos=txt.search(/^(\s+)$/m))!=-1){s.start-=this.params.indent_size;this.replaceSelection(s,'');return true;}return false;};codeEditor.prototype.insertBrackets=function(e,key){var s=this.getSelection();var o=key;var c=o;switch(o){case '(':c=')';break;case '[':c=']';break;case '{':c='}';break;}if(s.length==0)this.insertAtPosition(s.start,o+c,s.start+1);else this.wrapSelection(s,o,c);return true;};}());