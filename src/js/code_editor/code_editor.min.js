!function(){function t(){}var e;String.prototype.repeat=function(t){return new Array(t+1).join(this)},window.codeEditor=function(t){if(!textEditor.call(this,t))return!1;this.onlinechange=null,this.onlinenumberchange=null,this.fullscreen=!1,this.nb_lines=0,this.current_line=0,this.search_str=null,this.search_pos=0,this.params={indent_size:4,lang:{search:"Text to search?\n(regexps allowed, begin them with '/')",replace:"Text for replacement?\n(use $1, $2... for regexp replacement)",search_selection:"Text to replace in selection?\n(regexps allowed, begin them with '/')",replace_result:"%d occurence found and replaced.",goto:"Line to go to:",no_search_result:"No search result found."}},(that=this).init(),this.textarea.spellcheck=!1,this.shortcuts.push({shift:!0,key:"tab",callback:this.indent}),this.shortcuts.push({key:"tab",callback:this.indent}),this.shortcuts.push({ctrl:!0,key:"f",callback:this.search}),this.shortcuts.push({ctrl:!0,key:"h",callback:this.searchAndReplace}),this.shortcuts.push({ctrl:!0,key:"g",callback:this.goToLine}),this.shortcuts.push({key:"F3",callback:this.searchNext}),this.shortcuts.push({key:"backspace",callback:this.backspace}),this.shortcuts.push({key:"enter",callback:this.enter}),this.shortcuts.push({key:'"',callback:this.insertBrackets}),this.shortcuts.push({key:"'",callback:this.insertBrackets}),this.shortcuts.push({key:"[",callback:this.insertBrackets}),this.shortcuts.push({key:"{",callback:this.insertBrackets}),this.shortcuts.push({key:"(",callback:this.insertBrackets}),this.shortcuts.push({key:"F11",callback:this.toggleFullscreen}),this.textarea.addEventListener("keypress",this.keyEvent.bind(this),!0),this.textarea.addEventListener("keydown",this.keyEvent.bind(this),!0)},codeEditor.prototype=(e=textEditor.prototype,t.prototype=e,new t),codeEditor.prototype.init=function(){var t=this;for(this.nb_lines=this.countLines(),this.parent=document.createElement("div"),this.parent.className="codeEditor",this.lineCounter=document.createElement("span"),this.lineCounter.className="lineCount",i=1;i<=this.nb_lines;i++)this.lineCounter.innerHTML+="<b>"+i+"</b>";this.lineCounter.innerHTML+="<i>---</i>",this.parent.appendChild(this.lineCounter);var e=document.createElement("div");e.className="container",e.appendChild(this.textarea.cloneNode(!0)),this.parent.appendChild(e);var s=this.textarea.parentNode;s.appendChild(this.parent),s.removeChild(this.textarea),this.textarea=this.parent.getElementsByTagName("textarea")[0],this.textarea.wrap="off",this.textarea.style="tab-size: "+this.params.indent_size;e=(this.textarea.value.match(/^\t/gm)||[]).length,s=new RegExp("^[ ]{"+this.params.indent_size+"}","mg"),s=(this.textarea.value.match(s)||[]).length;this.indent_pattern=e<s?" ".repeat(this.params.indent_size):"\t",this.textarea.addEventListener("focus",function(){t.update()},!1),this.textarea.addEventListener("keyup",function(){t.update()},!1),this.textarea.addEventListener("click",function(){t.update()},!1),this.textarea.addEventListener("scroll",function(){t.lineCounter.scrollTop=t.textarea.scrollTop},!1)},codeEditor.prototype.update=function(){var t=this.getSelection(),e=this.getLineNumberFromPosition(t),s=this.countLines();if(this.search_pos=t.end,s!=this.nb_lines){for(var i=this.lineCounter.getElementsByTagName("b"),r=this.nb_lines;s<r;r--)this.lineCounter.removeChild(i[r-1]);for(var n=this.lineCounter.lastChild,r=i.length;r<s;r++){var a=document.createElement("b");a.innerHTML=r+1,this.lineCounter.insertBefore(a,n)}this.nb_lines=s,"function"==typeof this.onlinenumberchange&&this.onlinenumberchange.call(this)}if(e!=this.current_line){for(i=this.lineCounter.getElementsByTagName("b"),r=0;r<this.nb_lines;r++)i[r].className="";i[e].className="current",this.current_line=e,"function"==typeof this.onlinechange&&this.onlinechange.call(this)}},codeEditor.prototype.countLines=function(){var t=this.textarea.value.match(/(\r?\n)/g);return t?t.length+1:1},codeEditor.prototype.getLineNumberFromPosition=function(t){if(0==(t=t||this.getSelection()).start)return 0;t=this.textarea.value.substr(0,t.start).match(/(\r?\n)/g);return t?t.length:0},codeEditor.prototype.getLines=function(){return this.textarea.value.split("\n")},codeEditor.prototype.getLine=function(t){return this.textarea.value.split("\n",t+1)[t]},codeEditor.prototype.getLinePosition=function(t,e){var s=0;for(i=0;i<t.length;i++){if(i==e)return{start:s+i,end:s+t[i].length,length:t[i].length,text:t[i]};s+=t[i].length}return!1},codeEditor.prototype.selectLines=function(t){for(var e=t.start;0<e;e--)if("\n"==this.textarea.value.substr(e,1)){t.start=e+1;break}for(e=t.end-1;e<this.textarea.length;e++)if("\n"==this.textarea.value.substr(e,1)){t.end=e-1;break}return this.setSelection(t.start,t.end),t},codeEditor.prototype.goToLine=function(t){var e=window.prompt(that.params.lang.goto);if(e){e=this.textarea.value.split("\n",parseInt(e,10)).join("\n").length;return this.scrollToSelection(this.setSelection(e,e)),!0}},codeEditor.prototype.indent=function(t,e){var s=this.getSelection(),i=t.shiftKey,r=this.getLines(),n=this.getLineNumberFromPosition(s),a=this.getLinePosition(r,n),t=s.end>a.end;if((0==s.length||!t)&&s.start!=a.start)return this.insertAtPosition(s.start,this.indent_pattern),!0;t=new RegExp("^([ ]{"+this.params.indent_size+"}|\t)*");if(0==s.length&&s.start==a.start){var h=n-1 in r&&r[n-1].match(t);return h=h&&0==a.length?this.indent_pattern.repeat(h.length):this.indent_pattern,this.insertAtPosition(s.start,h),!0}s=this.selectLines(s);h=this.textarea.value.substr(s.start,s.end-s.start),r=h.split("\n");if(i)for(var o=new RegExp("^([ ]{"+this.params.indent_size+"}|\t)"),c=0;c<r.length;c++)r[c]=r[c].replace(o,"");else for(c=0;c<r.length;c++)r[c]=""==r[c].replace(/\s+/,"")?"":this.indent_pattern+r[c];return h=r.join("\n"),this.replaceSelection(s,h),!0},codeEditor.prototype.search=function(){if(this.search_str=window.prompt(this.params.lang.search,this.search_str||""))return this.search_pos=0,this.searchNext()},codeEditor.prototype.searchNext=function(){if(!this.search_str)return!0;var t=this.getSelection(),e=t.end>=this.search_pos?this.search_pos:t.start,s=this.textarea.value.substr(e),i=this.getSearchRegexp(this.search_str),r=s.search(i);if(-1==r)return window.alert(this.params.lang.no_search_result);i=s.match(i);return t.start=e+r,t.end=t.start+i[0].length,t.length=i[0].length,t.text=i[0],this.setSelection(t.start,t.end),this.search_pos=t.end,this.scrollToSelection(t),!0},codeEditor.prototype.getSearchRegexp=function(t,e){var s,i;return t="/"==t.substr(0,1)?(s=t.lastIndexOf("/"),i=t.substr(1,s-1),t.substr(s+1).replace(/g/,"")):(i=t.replace(/([\/$^.?()[\]{}\\])/,"\\$1"),"i"),e&&(t+="g"),new RegExp(i,t)},codeEditor.prototype.searchAndReplace=function(t){var e=this.getSelection(),i=0!=e.length?this.params.lang.search_selection:this.params.lang.search;if(!(s=window.prompt(i,this.search_str||""))||!(r=window.prompt(that.params.lang.replace)))return!0;var n,i=this.getSearchRegexp(s,!0);return 0==e.length?(n=this.textarea.value.match(i).length,this.textarea.value=this.textarea.value.replace(i,r)):(n=e.text.match(i).length,this.replaceSelection(e,e.text.replace(i,r))),window.alert(this.params.lang.replace_result.replace(/%d/g,n)),!0},codeEditor.prototype.enter=function(t){var e=this.getSelection();e.start!=e.end&&(this.replaceSelection(e,""),e=this.getSelection());var s=this.getLineNumberFromPosition(e),i="",r=!1,s=this.getLine(s);return"{"==this.textarea.value.substr(e.start-1,1)&&(i+=this.indent_pattern,r="}"==this.textarea.value.substr(e.start,1)),(match=s.match(/^(\s+)/))&&(i+=match[1]),!!i&&(this.insertAtPosition(e.start,"\n"+i),r&&(r=this.getSelection(),this.insertAtPosition(r.start,"\n"+i.substr(0,i.length-this.indent_pattern.length)),this.setSelection(r.start,r.end)),!0)},codeEditor.prototype.backspace=function(t){var e=this.getSelection();if(0<e.length)return!1;if('""'==(s=this.textarea.value.substr(e.start-1,2))||"''"==s||"{}"==s||"()"==s||"[]"==s)return--e.start,e.end+=1,this.replaceSelection(e,""),!0;var s=this.textarea.value.substr(e.start-20,20);return-1!=(pos=s.search(/([ \t]+)$/))&&(e.start-=20-pos,this.replaceSelection(e,""),!0)},codeEditor.prototype.insertBrackets=function(t,e){var s=this.getSelection(),e=e,i=e;switch(e){case"(":i=")";break;case"[":i="]";break;case"{":i="}"}return 0==s.length?this.insertAtPosition(s.start,e+i,s.start+1):this.wrapSelection(s,e,i),!0},codeEditor.prototype.toggleFullscreen=function(t){for(var e=this.parent.className.split(" "),s=0;s<e.length;s++)if("fullscreen"==e[s])return e.splice(s,1),this.parent.className=e.join(" "),!(this.fullscreen=!1);return e.push("fullscreen"),this.parent.className=e.join(" "),this.fullscreen=!0}}();