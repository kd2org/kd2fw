(function(){window.textEditor=function(id){if(!document.getElementById(id))throw new Exception("Invalid ID parameter");this.id=id;this.textarea=document.getElementById(id);this.shortcuts={};var that=this;this.textarea.addEventListener('keydown',function(e){var e=e||window.event;for(var key in that.shortcuts){var shortcut=that.shorcuts[key];if(shortcut.ctrl&&!e.ctrlKey)continue;if(shortcut.shift&&!e.shiftKey)continue;if(shortcut.alt&&!e.altKey)continue;var key=e.keyCode||e.charCode||e.which;if(that.keyToCharCode(shortcut.key)!=key)continue;return that.preventDefault();}});this.textarea.addEventListener('keypress',function(e){var e=e||window.event;for(var key in that.shortcuts){var shortcut=that.shorcuts[key];if(shortcut.ctrl&&!e.ctrlKey)continue;if(shortcut.shift&&!e.shiftKey)continue;if(shortcut.alt&&!e.altKey)continue;e.key=e.keyCode||e.charCode||e.which;if(that.keyToCharCode(shortcut.key)!=e.key)continue;shortcut.callback.call(e);return that.preventDefault();}});};textEditor.prototype.keyToCharCode=function(key){key=key.toUpperCase();if(match=key.match(/^F(\d+)$/))return 111+parseInt(match[1],10);switch(key){case 'SPACE':return 32;case 'ENTER':return 13;case 'TAB':return 9;case 'ESC':return 27;case 'BACKSPACE':return 8;case 'LEFT':return 37;case 'RIGHT':return 39;case 'UP':return 38;case 'DOWN':return 40;case 'INSERT':return 45;case 'DELETE':return 46;case 'HOME':return 36;case 'END':return 35;case 'PGUP':return 33;case 'PGDN':return 34;case 'PGDOWN':return 34;default:return key.charCodeAt(0);}};textEditor.prototype.preventDefault=function(e){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};textEditor.prototype.getSelection=function(){var e=this.textarea;if('selectionStart' in e){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)};}else if(document.selection){e.focus();var r=document.selection.createRange();var tr=e.createTextRange();var tr2=tr.duplicate();tr2.moveToBookmark(r.getBookmark());tr.setEndPoint('EndToStart',tr2);if(r==null||tr==null)return{start:e.value.length,end:e.value.length,length:0,text:''};var text_part=r.text.replace(/[\r\n]/g,'.');var text_whole=e.value.replace(/[\r\n]/g,'.');var the_start=text_whole.indexOf(text_part,tr.text.length);return{start:the_start,end:the_start+text_part.length,length:text_part.length,text:r.text};}else return{start:e.value.length,end:e.value.length,length:0,text:''};};textEditor.prototype.replaceSelection=function(selection,replace_str){var e=this.textarea;var start_pos=selection.start;var end_pos=start_pos+replace_str.length;e.value=e.value.substr(0,start_pos)+replace_str+e.value.substr(selection.end,e.value.length);this.setSelection(start_pos,end_pos);return{start:start_pos,end:end_pos,length:replace_str.length,text:replace_str};};textEditor.prototype.insert=function(start_pos,str){var end_pos=start_pos+str.length;var e=this.textarea;e.value=e.value.substr(0,start_pos)+str+e.value.substr(start_pos,e.value.length);this.setSelection(end_pos,end_pos);return{start:end_pos,end:end_pos,length:0};};textEditor.prototype.setSelection=function(start_pos,end_pos){var e=this.textarea;if('selectionStart' in e){e.focus();e.selectionStart=start_pos;e.selectionEnd=end_pos;}else if(document.selection){e.focus();var tr=e.createTextRange();var stop_it=start_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)start_pos=start_pos-.5;stop_it=end_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)end_pos=end_pos-.5;tr.moveEnd('textedit',-1);tr.moveStart('character',start_pos);tr.moveEnd('character',end_pos-start_pos);tr.select();}return this.getSelection();};textEditor.prototype.wrapSelection=function(left_str,right_str,sel_offset,sel_length){var e=this.textarea;var scroll=e.scrollTop;var the_sel_text=this.getSelection().text;var selection=this.replace(e,left_str+the_sel_text+right_str);if(the_sel_text=='')selection=this.setSelection(selection.start+left_str.length,selection.start+left_str.length);e.scrollTop=scroll;return selection;};}());(function(){window.codeEditor.prototype=textEditor;window.codeEditor.prototype.parent=textEditor;window.codeEdit=function(id){if(!document.getElementById(id))throw new Exception("Invalid ID parameter");this.id=id;this.textarea=document.getElementById(id);this.nb_lines=0;this.current_line=0;this.params={'indent':'    ','lang':{'search':"Text to search?\n(regexps allowed, begin them with '/')",'replace':"Text for replacement?\n(use $1, $2... for regexp replacement)",'goto':"Line to go to:",'no_search_result':"No search result found."}};this.init();};codeEdit.prototype.init=function(){var that=this;this.nb_lines=this.countLines();this.parent=document.createElement('div');this.parent.className='codeEdit';this.lineCounter=document.createElement('span');this.lineCounter.className='lineCount';for(i=1;i<=this.nb_lines;i++)this.lineCounter.innerHTML+='<b>'+i+"</b>\n";this.parent.appendChild(this.lineCounter);this.parent.appendChild(this.textarea.cloneNode(true));var pnode=this.textarea.parentNode;pnode.appendChild(this.parent);pnode.removeChild(this.textarea);this.textarea=this.parent.getElementsByTagName('textarea')[0];this.textarea.onclick=function(){that.update();};this.textarea.onfocus=function(){that.update();};this.textarea.onkeydown=function(e){var e=e||window.event;that.update();var key=e.keyCode||e.charCode;if(key==9){e.shiftKey?that.indent(true):that.indent(false);return that.preventDefault(e);}if(e.ctrlKey&&key==70){if(s=window.prompt(that.params.lang.search)){that.search(s);that.update();}return that.preventDefault(e);}if(key==114&&s){that.search(s,true);that.update();return that.preventDefault(e);}if(e.ctrlKey&&key==71&&(l=window.prompt(that.params.lang.goto))){that.goToLine(parseInt(l,10));that.update();return that.preventDefault(e);}if(e.ctrlKey&&key==72){if((s=window.prompt(that.params.lang.search))&&(r=window.prompt(that.params.lang.replace)))that.searchAndReplace(s,r);return that.preventDefault(e);}};this.textarea.onscroll=function(){that.lineCounter.scrollTop=that.textarea.scrollTop;};var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href='style/code_edit.css';document.head.appendChild(link);};codeEdit.prototype.preventDefault=function(e){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};codeEdit.prototype.update=function(){var line=this.getCurrentLine();var nb_lines=this.countLines();if(nb_lines!=this.nb_lines){var lines=this.lineCounter.getElementsByTagName('b');for(var i=this.nb_lines;i>nb_lines;i--)this.lineCounter.removeChild(lines[i-1]);for(var i=lines.length;i<nb_lines;i++)this.lineCounter.innerHTML+='<b>'+(i+1)+"</b>\n";this.nb_lines=nb_lines;}if(line!=this.current_line){var lines=this.lineCounter.getElementsByTagName('b');for(var i=0;i<this.nb_lines;i++)lines[i].className='';lines[line-1].className='current';this.current_line=line;}};codeEdit.prototype.goToLine=function(line){var l=this.textarea.value.split("\n",line).join("\n").length;selection.set(this.textarea,l,l);};codeEdit.prototype.indent=function(unindent){var c;var s=selection.get(this.textarea);for(var i=(s.start-1);i>=0;--i){c=this.textarea.value.substr(i,1);if(c=="\n"||i==0){s.start=i+1;break;}else if(s.length==0&&c!=" "&&c!="\t"){if(!unindent)selection.insert(this.textarea,s,this.params.indent);return;}}if(s.length==0)s.end=s.start+this.textarea.value.substr(s.start).indexOf("\n");var txt=this.textarea.value.substr(s.start,(s.end-s.start));var lines=txt.split("\n");if(unindent){var r=new RegExp('^'+this.params.indent);for(var i=0;i<lines.length;i++)lines[i]=lines[i].replace(r,'');}else for(var i=0;i<lines.length;i++)lines[i]=this.params.indent+lines[i];txt=lines.join("\n");selection.replace(this.textarea,s,txt);};codeEdit.prototype.search=function(search,next){var s=selection.get(this.textarea);if(next)s.start++;var pos=s.start;var txt=this.textarea.value.substr(pos);var r=this.getSearchRegexp(search);var found=txt.search(r);if(found==-1)return window.alert(this.params.lang.no_search_result);var match=txt.match(r);selection.set(this.textarea,pos+found,pos+found+match[0].length);return true;};codeEdit.prototype.getSearchRegexp=function(str){var r,m;if(str.substr(0,1)=='/'){var pos=str.lastIndexOf("/");r=str.substr(1,pos-1);m=str.substr(pos+1).replace(/g/,'');}else{r=str.replace(/([\/$^.?()[\]{}\\])/,'\\$1');m='i';}return new RegExp(r,m);};codeEdit.prototype.replace=function(selection,replace){};codeEdit.prototype.countLines=function(){var match=this.textarea.value.match(/(\r?\n)/g);return match?match.length+1:1;};codeEdit.prototype.getCurrentLine=function(){var s=selection.get(this.textarea);if(s.start==0)return 1;var match=this.textarea.value.substr(0,s.start).match(/(\r?\n)/g);return match?match.length+1:1;};var selection={get:function(e){if('selectionStart' in e){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)};}else if(document.selection){e.focus();var r=document.selection.createRange();var tr=e.createTextRange();var tr2=tr.duplicate();tr2.moveToBookmark(r.getBookmark());tr.setEndPoint('EndToStart',tr2);if(r==null||tr==null)return{start:e.value.length,end:e.value.length,length:0,text:''};var text_part=r.text.replace(/[\r\n]/g,'.');var text_whole=e.value.replace(/[\r\n]/g,'.');var the_start=text_whole.indexOf(text_part,tr.text.length);return{start:the_start,end:the_start+text_part.length,length:text_part.length,text:r.text};}else return{start:e.value.length,end:e.value.length,length:0,text:''};},replace:function(e,selection,replace_str){var start_pos=selection.start;var end_pos=start_pos+replace_str.length;e.value=e.value.substr(0,start_pos)+replace_str+e.value.substr(selection.end,e.value.length);this.set(e,start_pos,end_pos);return{start:start_pos,end:end_pos,length:replace_str.length,text:replace_str};},insert:function(e,selection,str){var start_pos=selection.start;var end_pos=start_pos+str.length;e.value=e.value.substr(0,start_pos)+str+e.value.substr(selection.end,e.value.length);this.set(e,end_pos,end_pos);return{start:end_pos,end:end_pos,length:0};},set:function(e,start_pos,end_pos){if('selectionStart' in e){e.focus();e.selectionStart=start_pos;e.selectionEnd=end_pos;}else if(document.selection){e.focus();var tr=e.createTextRange();var stop_it=start_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)start_pos=start_pos-.5;stop_it=end_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)end_pos=end_pos-.5;tr.moveEnd('textedit',-1);tr.moveStart('character',start_pos);tr.moveEnd('character',end_pos-start_pos);tr.select();}return this.get(e);},wrap:function(e,left_str,right_str,sel_offset,sel_length){var scroll=e.scrollTop;var the_sel_text=this.get(e).text;var selection=this.replace(e,left_str+the_sel_text+right_str);if(sel_offset!==undefined&&sel_length!==undefined)selection=this.set(e,selection.start+sel_offset,selection.start+sel_offset+sel_length);else if(the_sel_text=='')selection=this.set(e,selection.start+left_str.length,selection.start+left_str.length);e.scrollTop=scroll;return selection;}};}());