(function(){var e=function(e){this.columns=e};function l(e,t){while((e=e.parentElement)&&!(e.matches||e.matchesSelector).call(e,t));return e}window.SQLQueryBuilder=e;e.prototype.loadDefaultOperators=function(){this.operators={"= ?":this.__("is equal to"),"!= ?":this.__("is not equal to"),"IN (??)":this.__("is equal to one of"),"NOT IN (??)":this.__("is not equal to one of"),"> ?":this.__("is greater than"),">= ?":this.__("is greater than or equal to"),"< ?":this.__("is less than"),"<= ?":this.__("is less than or equal to"),"BETWEEN ? AND ?":this.__("is between"),"NOT BETWEEN ? AND ?":this.__("is not between"),"IS NULL":this.__("is null"),"IS NOT NULL":this.__("is not null"),"LIKE ?%":this.__("begins with"),"NOT LIKE ?%":this.__("doesn't begin with"),"LIKE %?":this.__("ends with"),"NOT LIKE %?":this.__("doesn't end with"),"LIKE %?%":this.__("contains"),"NOT LIKE %?%":this.__("doesn't contain"),"&":this.__("matches one of"),"NOT &":this.__("doesn't match one of"),"= 1":this.__("is true"),"= 0":this.__("is false")};this.types_operators={integer:["= ?","!= ?","IN (??)","NOT IN (??)","> ?",">= ?","< ?","<= ?","BETWEEN ? AND ?","NOT BETWEEN ? AND ?"],enum:["= ?","!= ?","IN (??)","NOT IN (??)"],boolean:["= 1","= 0"],text:["= ?","!= ?","IN (??)","NOT IN (??)","LIKE ?%","NOT LIKE ?%","LIKE %?","NOT LIKE %?","LIKE %?%","NOT LIKE %?%"],bitwise:["&","NOT &"]};for(var e in this.types_operators){var t={};for(var i in this.types_operators[e]){var o=this.types_operators[e][i];t[o]=this.operators[o]}this.types_operators[e]=t}this.types_operators["date"]=JSON.parse(JSON.stringify(this.types_operators["integer"]));delete this.types_operators["date"]["<= ?"];delete this.types_operators["date"][">= ?"];this.types_operators["date"]["< ?"]=this.__("before");this.types_operators["date"]["> ?"]=this.__("after");this.types_operators["datetime"]=this.types_operators["date"];this.default_operator=null};e.prototype.__=function(e){return e};e.prototype.init=function(e){this.parent=e;var t={"":"---"};for(column in this.columns){t[column]=this.columns[column].label}this.columnSelect=this.buildSelect(t)};e.prototype.addGroup=function(t,e,i){var o=document.createElement("fieldset");var r=document.createElement("legend");var n=this.buildSelect({AND:this.__("Matches ALL of the following conditions:"),OR:this.__("Matches ANY of the following conditions:"),ADD:this.__("Add a new set of conditions below this one"),DEL:this.__("Remove this set of conditions")});n.name="operator";n.onfocus=function(){this.oldValue=this.value};n.value=e;var a=this;n.onchange=function(){if(this.value=="DEL"){if(t.childNodes.length==1){this.value=this.oldValue;return}t.removeChild(o)}else if(this.value=="ADD"){var e=a.addGroup(t,"AND");a.addRow(e);this.value=this.oldValue}};if(t.childNodes.length>=1){var s=this.buildSelect({AND:this.__("AND"),OR:this.__("OR")});s.name="join_operator";r.appendChild(s);r.appendChild(document.createTextNode(" "));s.value=i}r.appendChild(n);o.appendChild(r);var l=document.createElement("table");o.appendChild(l);t.appendChild(o);return o};e.prototype.addRow=function(e,t){var i=e.getElementsByTagName("table")[0];var o=document.createElement("tr");var r=document.createElement("td");r.className="buttons";var n=this;var a=this.buildInput("button","+");a.onclick=function(){n.addRow(l(this,"fieldset"),this.parentNode.parentNode)};r.appendChild(a);var a=this.buildInput("button","-");a.onclick=function(){n.deleteRow(this.parentNode.parentNode)};r.appendChild(a);o.appendChild(r);var r=document.createElement("td");r.className="column";var s=this.columnSelect.cloneNode(true);s.onchange=function(){return n.switchColumn(this)};r.appendChild(s);o.appendChild(r);var r=document.createElement("td");r.className="operator";o.appendChild(r);var r=document.createElement("td");r.className="values";o.appendChild(r);if(typeof t=="undefined"){i.appendChild(o)}else{i.insertBefore(o,t.nextSibling)}return o};e.prototype.deleteRow=function(e){if(e.parentNode.childNodes.length<=1)return;e.parentNode.removeChild(e)};e.prototype.switchColumn=function(e){var t=e.parentNode.parentNode;var i=t.cells[2].firstChild.value;var o=this.getValues(t);t.childNodes[2].innerHTML="";if(!e.value){return}var r=this.columns[e.value];var n=this.addOperator(t,r);var a=this.types_operators[r.type];if(i&&a.hasOwnProperty(i)){n.value=i}else{if(this.default_operator&&a.hasOwnProperty(this.default_operator)){n.value=this.default_operator}else{n.value=n.children[1].value}o=null}this.switchOperator(n,o)};e.prototype.addOperator=function(e,t){var i=this.types_operators[t.type];var o={"":"---"};if(t.null){i["IS NULL"]=this.operators["IS NULL"];i["IS NOT NULL"]=this.operators["IS NOT NULL"]}for(var r in i){o[r]=i[r]}var n=this.buildSelect(o);var a=this;n.onchange=function(){return a.switchOperator(this)};e.childNodes[2].appendChild(n);return n};e.prototype.switchOperator=function(e,t){var i=e.parentNode.parentNode;if(!t&&i.childNodes[3].firstChild){t=[i.childNodes[3].firstChild.value]}i.childNodes[3].innerHTML="";var o=i.childNodes[3];var r=i.childNodes[1].firstChild;var n=e.value;var a=this.columns[r.value];if(!n){return}var s=1;var l=false;var u=null;var h=n.match(/\?/g);if(h&&n.match(/\?\?/)){s=t?t.length:1;l=true}else if(h&&h.length>=1){s=h.length}else if(a.type=="bitwise"&&(n=="&"||n=="NOT &")){s=1}else{return}for(var d=0;d<s;d++){u=this.addMatchField(o,u,a,n);if(a.type=="bitwise"&&t){for(var p=0;p<a.values.length;p++){o.querySelectorAll("input")[p].checked=t.indexOf(p.toString())!=-1}}else if(t){u.value=t[d]}}if(l){var c=this.buildInput("button","-");c.onclick=function(){if(this.parentNode.childNodes.length<=3)return;this.parentNode.removeChild(this.previousSibling);this.parentNode.removeChild(this.previousSibling)};o.appendChild(c);var c=this.buildInput("button","+");var v=this;c.onclick=function(){v.addMatchField(o,this.previousSibling.previousSibling,a,n)};o.appendChild(c)}};e.prototype.addMatchField=function(e,t,i,o){if(i.type=="enum"){var r=this.buildSelect(i.values)}else if(i.type=="bitwise"){var r=document.createElement("span");for(var n in i.values){var a=this.buildInput("checkbox",n);var s=document.createElement("label");s.appendChild(a);s.appendChild(document.createTextNode(" "+i.values[n]));r.appendChild(s.cloneNode(true))}}else{var r=this.buildInput(i.type,"",i)}r=e.insertBefore(r,t?t.nextSibling:null);if(t){e.insertBefore(document.createElement("br"),r)}return r};e.prototype.buildInput=function(e,t,i){var o=document.createElement("input");o.type=e=="integer"?"number":e;o.value=t;return o};e.prototype.buildSelect=function(e){var t=document.createElement("select");for(var i in e){var o=document.createElement("option");o.value=i;o.innerHTML=e[i];t.appendChild(o)}return t};e.prototype.import=function(e){for(var t in e){if(e[t].conditions.length==0){continue}var i=this.addGroup(this.parent,e[t].operator,e[t].join_operator??null);for(var o in e[t].conditions){var r=e[t].conditions[o];var n=this.addRow(i);n.childNodes[1].firstChild.value=r.column;if(!this.columns[r.column]){continue}var a=this.addOperator(n,this.columns[r.column]);a.value=r.operator;this.switchOperator(a,r.values)}}};e.prototype.getValues=function(e){var t=Array.prototype.slice.call(e.cells[3].querySelectorAll("input, select")).map(function(e){if(e.type=="checkbox"){return e.checked?e.value:null}else if(e.type!="button"){return e.value}});t=t.filter(function(e){return e===null?false:true});return t};e.prototype.export=function(){var e=this.parent.querySelectorAll("table");var t=[];for(var i in e){if(!e.hasOwnProperty(i))continue;i=e[i];var o=i.rows;var r=[];for(var n=0;n<o.length;n++){var s=o[n];if(!s.getElementsByTagName("select")[0].value){continue}var l={column:s.cells[1].firstChild.value,operator:s.cells[2].firstChild.value,values:this.getValues(s)};if(!l.operator){continue}r.push(l)}t.push({operator:i.parentNode.querySelector("select[name=operator]").value,join_operator:(a=i.parentNode.querySelector("select[name=join_operator]"))?a.value:null,conditions:r})}return t}})();
