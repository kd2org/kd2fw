(function(){window.textEditor=function(id){if(!document.getElementById(id))throw new Exception("Invalid ID parameter");this.id=id;this.textarea=document.getElementById(id);this.shortcuts={};var that=this;this.textarea.addEventListener('keydown',function(e){var e=e||window.event;for(var key in that.shortcuts){var shortcut=that.shorcuts[key];if(shortcut.ctrl&&!e.ctrlKey)continue;if(shortcut.shift&&!e.shiftKey)continue;if(shortcut.alt&&!e.altKey)continue;var key=e.keyCode||e.charCode||e.which;if(that.keyToCharCode(shortcut.key)!=key)continue;return that.preventDefault();}});this.textarea.addEventListener('keypress',function(e){var e=e||window.event;for(var key in that.shortcuts){var shortcut=that.shorcuts[key];if(shortcut.ctrl&&!e.ctrlKey)continue;if(shortcut.shift&&!e.shiftKey)continue;if(shortcut.alt&&!e.altKey)continue;e.key=e.keyCode||e.charCode||e.which;if(that.keyToCharCode(shortcut.key)!=e.key)continue;shortcut.callback.call(e);return that.preventDefault();}});};textEditor.prototype.keyToCharCode=function(key){key=key.toUpperCase();if(match=key.match(/^F(\d+)$/))return 111+parseInt(match[1],10);switch(key){case 'SPACE':return 32;case 'ENTER':return 13;case 'TAB':return 9;case 'ESC':return 27;case 'BACKSPACE':return 8;case 'LEFT':return 37;case 'RIGHT':return 39;case 'UP':return 38;case 'DOWN':return 40;case 'INSERT':return 45;case 'DELETE':return 46;case 'HOME':return 36;case 'END':return 35;case 'PGUP':return 33;case 'PGDN':return 34;case 'PGDOWN':return 34;default:return key.charCodeAt(0);}};textEditor.prototype.preventDefault=function(e){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};textEditor.prototype.getSelection=function(){var e=this.textarea;if('selectionStart' in e){var l=e.selectionEnd-e.selectionStart;return{start:e.selectionStart,end:e.selectionEnd,length:l,text:e.value.substr(e.selectionStart,l)};}else if(document.selection){e.focus();var r=document.selection.createRange();var tr=e.createTextRange();var tr2=tr.duplicate();tr2.moveToBookmark(r.getBookmark());tr.setEndPoint('EndToStart',tr2);if(r==null||tr==null)return{start:e.value.length,end:e.value.length,length:0,text:''};var text_part=r.text.replace(/[\r\n]/g,'.');var text_whole=e.value.replace(/[\r\n]/g,'.');var the_start=text_whole.indexOf(text_part,tr.text.length);return{start:the_start,end:the_start+text_part.length,length:text_part.length,text:r.text};}else return{start:e.value.length,end:e.value.length,length:0,text:''};};textEditor.prototype.replaceSelection=function(selection,replace_str){var e=this.textarea;var start_pos=selection.start;var end_pos=start_pos+replace_str.length;e.value=e.value.substr(0,start_pos)+replace_str+e.value.substr(selection.end,e.value.length);this.setSelection(start_pos,end_pos);return{start:start_pos,end:end_pos,length:replace_str.length,text:replace_str};};textEditor.prototype.insert=function(start_pos,str){var end_pos=start_pos+str.length;var e=this.textarea;e.value=e.value.substr(0,start_pos)+str+e.value.substr(start_pos,e.value.length);this.setSelection(end_pos,end_pos);return{start:end_pos,end:end_pos,length:0};};textEditor.prototype.setSelection=function(start_pos,end_pos){var e=this.textarea;if('selectionStart' in e){e.focus();e.selectionStart=start_pos;e.selectionEnd=end_pos;}else if(document.selection){e.focus();var tr=e.createTextRange();var stop_it=start_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)start_pos=start_pos-.5;stop_it=end_pos;for(i=0;i<stop_it;i++)if(e.value[i].search(/[\r\n]/)!=-1)end_pos=end_pos-.5;tr.moveEnd('textedit',-1);tr.moveStart('character',start_pos);tr.moveEnd('character',end_pos-start_pos);tr.select();}return this.getSelection();};textEditor.prototype.wrapSelection=function(left_str,right_str,sel_offset,sel_length){var e=this.textarea;var scroll=e.scrollTop;var the_sel_text=this.getSelection().text;var selection=this.replace(e,left_str+the_sel_text+right_str);if(the_sel_text=='')selection=this.setSelection(selection.start+left_str.length,selection.start+left_str.length);e.scrollTop=scroll;return selection;};}());