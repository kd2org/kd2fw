<?php

use KD2\Test;
use KD2\Office\Excel\Reader;

require __DIR__ . '/../../_assert.php';

function test_reader(string $str)
{
	$r = new Reader;
	$r->openString($str);

	$sheets = $r->listSheets();
	Test::equals(2, count($sheets));
	Test::assert(in_array('Feuille1', $sheets));
	Test::assert(in_array('Test <> weird sheet name', $sheets));
	Test::assert(1 === array_search('Test <> weird sheet name', $sheets, true));

	$rows = iterator_to_array($r->iterate(1));
	Test::assert(2 === count($rows));
	Test::assert(4 === count($rows[1]));
	Test::assert(1 === $rows[1][0]);
	Test::assert(2 === $rows[1][1]);
	Test::assert(3 === $rows[1][2]);
	Test::assert(4 === $rows[1][3]);
	Test::assert(4 === count($rows[0]));
	Test::assert('A' === $rows[0][0]);
	Test::assert('B' === $rows[0][1]);
	Test::assert('' === $rows[0][2]);
	Test::assert('D' === $rows[0][3]);

	$rows = iterator_to_array($r->iterate(0));
	Test::assert(8 === count($rows));

	foreach ($rows as $row) {
		Test::assert(2 === count($row));
	}

	Test::isInstanceOf(DateTime::class, $rows[0][0]);
	Test::assert('2026-02-01 00:00:00', $rows[0][0]->format('Y-m-d H:i:s'));
	Test::assert(3 === $rows[0][1]);
	Test::assert(1.02 === $rows[1][0]);
	Test::assert(0.1403 === $rows[2][0]);
	Test::isInstanceOf(DateTime::class, $rows[3][0]);
	Test::assert('2026-01-01 02:02:01', $rows[3][0]->format('Y-m-d H:i:s'));
	Test::assert(3 === $rows[4][0]);
	Test::assert(3.0004 === $rows[4][1]);
	Test::assert("Line 1\nLine 2" === $rows[5][0]);

}

$xlsx = <<<EOF
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
EOF;

test_reader(base64_decode($xlsx));
